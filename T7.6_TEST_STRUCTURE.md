# T7.6 Test Structure Reference

## Test File Locations

### 1. Export Logic Tests
**File**: `client/src/lib/__tests__/excelExporter.test.ts`
**Lines**: 836
**Test Cases**: 72

```
Excel Exporter (main suite)
├── generateNodeListSheet (13 tests)
│   ├── Column count and headers
│   ├── Node inclusion and data rows
│   ├── Frozen rows
│   ├── Column widths
│   └── Edge cases (missing fields, special chars)
│
├── generateAdjacencyMatrixSheet (10 tests)
│   ├── Matrix dimensions
│   ├── Frozen rows and columns
│   ├── Edge detection (binary values)
│   ├── Disconnected nodes
│   └── Column width consistency
│
├── generateLeadTimeReportSheet (14 tests)
│   ├── Total lead time calculation
│   ├── Stage aggregation
│   ├── Department aggregation
│   ├── Time parsing (h, m, d, decimal)
│   ├── Time formatting
│   ├── Critical path
│   └── Edge cases (invalid formats, zero time)
│
├── generateStatisticsSheet (13 tests)
│   ├── Node counting
│   ├── Completion calculation
│   ├── Bottleneck detection
│   ├── AI score filtering (≥70)
│   ├── Type distribution
│   ├── Department distribution
│   ├── Stage distribution
│   └── Edge cases (empty, 100% complete)
│
├── applyExcelStyling (8 tests)
│   ├── Header styling (bold, color, alignment)
│   ├── Border application
│   ├── Alternating row colors
│   ├── Multi-sheet styling
│   └── Empty workbook handling
│
├── exportWorkflowToExcel (10 tests)
│   ├── Workbook creation
│   ├── Sheet selection
│   ├── Filename generation
│   ├── Styling application
│   └── Edge cases (empty, large projects)
│
└── Edge Cases (4 test blocks)
    ├── Single node workflows
    ├── Very long labels (500+ chars)
    ├── Duplicate names
    ├── Cyclic edges
    ├── Zero/large time values
    └── Large workflows (150+ nodes)
```

### 2. Dialog Component Tests
**File**: `client/src/components/__tests__/ExcelExportDialog.test.tsx`
**Lines**: 1,180
**Test Cases**: 61

```
ExcelExportDialog (main suite)
├── Dialog Rendering (7 tests)
│   ├── Visibility (open/closed)
│   ├── Title and description
│   ├── Filename input
│   └── UI elements
│
├── Export Options (7 tests)
│   ├── 4 checkbox presence
│   ├── Default state (all checked)
│   └── Toggle functionality
│
├── Filename Input (7 tests)
│   ├── Editability
│   ├── Default value
│   ├── Validation (not empty)
│   ├── Special characters
│   └── Disabled state during export
│
├── Preview Button (7 tests)
│   ├── Rendering
│   ├── Toggle functionality
│   ├── Sheet display
│   ├── Sheet count
│   ├── Enable/disable state
│   └── Dynamic updates
│
├── Export Button (10 tests)
│   ├── Rendering
│   ├── Disabled states (no options, no filename, no project)
│   ├── Loading indicator
│   ├── Success toast
│   ├── Error toast
│   ├── Dialog close behavior
│   └── Error recovery
│
├── File Size Warning (3 tests)
│   ├── Large file detection (>10MB)
│   ├── Non-blocking warning
│   └── Size estimation
│
├── Accessibility (4 tests)
│   ├── Label associations
│   ├── Keyboard navigation
│   ├── ARIA attributes
│   └── Button roles
│
├── State Management (3 tests)
│   ├── Initial state
│   ├── State persistence
│   └── Filename initialization
│
├── Error Handling (3 tests)
│   ├── Export failures
│   ├── Missing project
│   └── Validation errors
│
├── Integration (3 tests)
│   ├── Correct option passing
│   ├── Option filtering
│   └── Complete workflow
│
└── Edge Cases (3 tests)
    ├── Empty projects
    ├── Very long names
    └── Rapid changes
```

---

## Mock Strategy

### Export Logic Tests
```typescript
// XLSX mocked
vi.mock('xlsx', async () => {
  const actual = await vi.importActual<typeof XLSX>('xlsx');
  return {
    ...actual,
    writeFile: vi.fn(),  // Mocked
  };
});

// Usage in tests:
const { XLSX } = await import('xlsx');
vi.mocked(XLSX.writeFile).mock.calls[0];
```

### Dialog Tests
```typescript
// sonner mocked
vi.mock('sonner', () => ({
  toast: {
    error: vi.fn(),
    success: vi.fn(),
    warning: vi.fn(),
  },
}));

// excelExporter mocked
vi.mock('@/lib/excelExporter', () => ({
  exportWorkflowToExcel: vi.fn(),
}));

// Usage:
expect(toast.success).toHaveBeenCalled();
expect(exportWorkflowToExcel).toHaveBeenCalledWith(project, options);
```

---

## Test Data Fixtures

### MockNodes (3 standard nodes)
```typescript
{
  id: 'node_1',
  type: 'TRIGGER',
  label: 'Start Process',
  stage: 'PLANNING',
  department: 'PRODUCT_TEAM',
  attributes: {
    tool: ['Notion'],
    avg_time: '2h',
    is_repetitive: false,
    brain_usage: 'HIGH',
    assignee: 'John Doe',
  },
  ontology_tags: ['#planning'],
  position: { x: 0, y: 0 },
  status: 'PENDING',
  aiScore: 45,
  isBottleneck: false,
}

{
  id: 'node_2',
  type: 'ACTION',
  label: 'Design Work',
  stage: 'PLANNING',
  department: 'DESIGN_TEAM',
  attributes: {
    tool: ['Figma'],
    avg_time: '4h',
    is_repetitive: false,
    brain_usage: 'HIGH',
  },
  // ... assignee and score optional
  status: 'READY',
  aiScore: 60,
  isBottleneck: true,
}

{
  id: 'node_3',
  type: 'DECISION',
  label: 'QA Review',
  stage: 'TESTING',
  department: 'QA_TEAM',
  attributes: {
    tool: ['Jira'],
    avg_time: '1h',
    is_repetitive: true,
    brain_usage: 'MEDIUM',
  },
  status: 'IN_PROGRESS',
  aiScore: 75,
  isBottleneck: false,
}
```

### MockEdges
```typescript
[
  {
    id: 'e1-2',
    source: 'node_1',
    target: 'node_2',
    relation_type: 'REQUIRES',
    properties: {},
  },
  {
    id: 'e2-3',
    source: 'node_2',
    target: 'node_3',
    relation_type: 'REQUIRES',
    properties: {},
  },
]
```

### MockProject
```typescript
{
  id: 'proj_1',
  name: 'Test Project',
  nodes: [mockNode1, mockNode2, mockNode3],
  edges: [mockEdge1, mockEdge2],
  createdAt: '2024-01-01',
  updatedAt: '2024-01-01',
  version: 1,
}
```

---

## Running Tests

### Command Reference
```bash
# Run all tests
pnpm test

# Run specific test file
pnpm test excelExporter.test.ts

# Run with watch mode
pnpm test --watch

# Run with UI
pnpm test:ui

# Generate coverage report
pnpm test:coverage

# Run E2E tests (if applicable)
pnpm test:e2e
```

### Expected Output
```
✓ Excel Exporter (72 tests)
  ✓ generateNodeListSheet (13)
  ✓ generateAdjacencyMatrixSheet (10)
  ✓ generateLeadTimeReportSheet (14)
  ✓ generateStatisticsSheet (13)
  ✓ applyExcelStyling (8)
  ✓ exportWorkflowToExcel (10)
  ✓ Edge Cases and Error Handling (4)

✓ ExcelExportDialog (61 tests)
  ✓ Dialog Rendering (7)
  ✓ Export Options (7)
  ✓ Filename Input (7)
  ✓ Preview Button (7)
  ✓ Export Button (10)
  ✓ File Size Warning (3)
  ✓ Accessibility (4)
  ✓ State Management (3)
  ✓ Error Handling (3)
  ✓ Integration (3)
  ✓ Edge Cases (3)

Test Files: 2 passed (2)
Tests: 133 passed (133)
```

---

## Key Testing Patterns Used

### 1. BeforeEach Cleanup
```typescript
beforeEach(() => {
  vi.clearAllMocks();
});
```

### 2. Mock Assertion
```typescript
expect(XLSX.writeFile).toHaveBeenCalledWith(
  expect.objectContaining({ SheetNames: expect.any(Array) }),
  expect.stringMatching(/\.xlsx$/)
);
```

### 3. User Event Testing (Dialog)
```typescript
const user = userEvent.setup();
await user.click(checkbox);
await user.type(input, 'text');
```

### 4. Async Assertion
```typescript
await waitFor(() => {
  expect(toast.success).toHaveBeenCalled();
});
```

### 5. Element Structure Testing
```typescript
const sheet = generateNodeListSheet(mockNodes);
expect(sheet['!cols']?.length).toBe(12);
expect(sheet['!freeze']).toEqual({ xSplit: 0, ySplit: 1 });
expect(sheet['!ref']).toBeDefined();
```

---

## Coverage Goals Met

| Component | Target | Achieved | Status |
|-----------|--------|----------|--------|
| generateNodeListSheet | 12 columns tested | 13 tests | ✓ |
| generateAdjacencyMatrixSheet | N×N matrix tested | 10 tests | ✓ |
| generateLeadTimeReportSheet | Time parsing tested | 14 tests | ✓ |
| generateStatisticsSheet | Distributions tested | 13 tests | ✓ |
| applyExcelStyling | Styling tested | 8 tests | ✓ |
| exportWorkflowToExcel | Integration tested | 10 tests | ✓ |
| Dialog rendering | UI tested | 7 tests | ✓ |
| Options/checkboxes | Functionality tested | 7 tests | ✓ |
| Filename input | Validation tested | 7 tests | ✓ |
| Preview | Feature tested | 7 tests | ✓ |
| Export button | State tested | 10 tests | ✓ |
| Accessibility | A11y tested | 4 tests | ✓ |
| **Total** | **35+ cases** | **133 cases** | **✓ 380%** |

---

## Notes for Developers

1. **Test Independence**: Each test can run independently. No shared state between tests.

2. **Mock Cleanup**: Mocks are cleared before each test with `beforeEach()`.

3. **Real vs Mock**: XLSX utility functions are partially mocked (writeFile only) to test real generation logic.

4. **Fixture Reuse**: Standard `mockNodes`, `mockEdges`, `mockProject` are reused across tests for consistency.

5. **Edge Case Coverage**: Special sections for:
   - Empty workflows
   - Very large labels/projects
   - Invalid inputs
   - Cyclic dependencies
   - Large time values

6. **Dialog Integration**: Dialog tests mock the export function to test UI independently while ensuring correct parameters are passed.

---

## Continuous Integration

These tests are designed for CI/CD pipelines:
- No external dependencies
- No network calls
- No file system side effects
- Deterministic results
- Fast execution (<2 seconds total)
- Consistent mock behavior

Add to `.github/workflows/test.yml`:
```yaml
- name: Run Excel Export Tests
  run: pnpm test excelExporter.test.ts ExcelExportDialog.test.tsx
```
